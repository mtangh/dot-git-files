---
# vim: set ff=unix ts=2 sw=2 sts=2 et : This line is VIM modeline

language: minimal

# Use the new container infrastructure
sudo: false

# Install packages
install: true

# Run
script:

  # Git files update
  - |
    set -x
    dotgit_root=$(pwd)
    gitconf_dir="${HOME}/.config/git"
    : "Basic syntax check" && {
      bash -n update.sh &&
      bash -n gitfilesupdate.sh &&
      : "OK"
    } &&
    : "Run with --global" && {
      rm -rf "${gitconf_dir}" 1>/dev/null 2>&1
      mkdir -p "${gitconf_dir}" &&
      bash -x -- ${dotgit_root}/gitfilesupdate.sh --global &&
      [   -r "${gitconf_dir}/ignore" ] &&
      [   -r "${gitconf_dir}/attributes" ] &&
      [   -x "${gitconf_dir}/gitfilesupdate.sh" ] &&
      [   -x "${gitconf_dir}/gitkeep.sh" ] &&
      [ ! -r "${gitconf_dir}/config" ] &&
      [ ! -r "${gitconf_dir}/config.local.tmplt" ] &&
      : "OK"
    } &&
    : "Run with --global and --with-config" && {
      rm -rf "${gitconf_dir}" 1>/dev/null 2>&1
      mkdir -p "${gitconf_dir}" &&
      bash -x -- ${dotgit_root}/gitfilesupdate.sh --global --with-config &&
      [ -r "${gitconf_dir}/ignore" ] &&
      [ -r "${gitconf_dir}/attributes" ] &&
      [ -x "${gitconf_dir}/gitfilesupdate.sh" ] &&
      [ -x "${gitconf_dir}/gitkeep.sh" ] &&
      [ -r "${gitconf_dir}/config" ] &&
      [ -r "${gitconf_dir}/config.local.tmplt" ] &&
      : "OK"
    } &&
    : "Run with --global and --with-config (No XDG_CONFIG_HOME)" && {
      rm -rf "${gitconf_dir}" 1>/dev/null 2>&1
      bash -x -- ${dotgit_root}/gitfilesupdate.sh --global --with-config &&
      [ -r "${HOME}/.gitignore" ] &&
      [ -r "${HOME}/.gitattributes" ] &&
      [ -x "${HOME}/.gitfilesupdate.sh" ] &&
      [ -x "${HOME}/.gitkeep.sh" ] &&
      [ -r "${HOME}/.gitconfig" ] &&
      [ -r "${HOME}/.gitconfig.local.tmplt" ] &&
      : "OK"
    } &&
    : "Run with --project" && {
      rm -rf "${HOME}/test" 1>/dev/null 2>&1
      ( git init "${HOME}/test" &&
        cd "${HOME}/test" &&
        bash -x -- ${dotgit_root}/gitfilesupdate.sh --project ) &&
      [ -r "${HOME}/test/.gitignore" ] &&
      [ -r "${HOME}/test/.gitattributes" ] &&
      [ -x "${HOME}/test/.gitfilesupdate.sh" ] &&
      [ -x "${HOME}/test/.gitkeep.sh" ] &&
      : "OK"
    } &&
    : "DONE."
    : "Run with --local" && {
      rm -rf "${HOME}/test" 1>/dev/null 2>&1
      ( git init "${HOME}/test" &&
        cd "${HOME}/test" &&
        bash -x -- ${dotgit_root}/gitfilesupdate.sh --local ) &&
      [   -r "${HOME}/test/.git/info/excludes" ] &&
      [   -r "${HOME}/test/.git/info/attributes" ] &&
      [ ! -x "${HOME}/test/.git/info/gitfilesupdate.sh" ] &&
      [ ! -x "${HOME}/test/.git/info/gitkeep.sh" ] &&
      : "OK"
    } &&
    : "DONE."

  # Gitkeep
  - |
    set -x
    base_dir=$(pwd)
    mkdir -p t/{dir1,dir2,dir3/child1,dir3/child2} || :
    find ./t -type f -exec rm -f {} \; || :
    : "Basic syntax check" && {
      bash -n gitkeep.sh &&
      : "OK"
    } &&
    : "Create Gitkeep" && {
      touch t/dir1/file1.txt &&
      touch t/dir3/child1/file2.txt &&
      bash -x -- "${base_dir}/gitkeep.sh" ./t &&
      [ ! -r "t/dir1/.gitkeep" ] &&
      [   -r "t/dir2/.gitkeep" ] &&
      [ ! -r "t/dir3/child1/.gitkeep" ] &&
      [   -r "t/dir3/child2/.gitkeep" ] &&
      : "OK"
    } &&
    : "Rebuild Gitkeep" && {
      mv -f t/dir{1,2}/file1.txt &&
      mv -f t/dir3/child{1,2}/file2.txt &&
      bash -x -- "${base_dir}/gitkeep.sh" --rebuild ./t &&
      [   -r "t/dir1/.gitkeep" ] &&
      [ ! -r "t/dir2/.gitkeep" ] &&
      [   -r "t/dir3/child1/.gitkeep" ] &&
      [ ! -r "t/dir3/child2/.gitkeep" ] &&
      : "OK"
    } &&
    : "DONE."

  - bash .travis-tests.sh


# Notifications
#notifications:
#  email:
#  - your@emailaddress

